# Using S3 compatible object storage in PHP

You can find more examples and code samples written in PHP that demonstrate how to interact with Amazon Simple Storage Service (Amazon S3) on the page [PHP Code Samples for Amazon S3](https://docs.aws.amazon.com/code-samples/latest/catalog/code-catalog-php-example_code-s3.html).

## Installing required SDKs

* Use [Composer](https://getcomposer.org) as a dependency manager for PHP. It's already globally pre-installed in each Zerops PHP Service, and you can install it also in your local development environment.

* Create the `composer.json` file with the preferable version of [AWS SDK for PHP](https://aws.amazon.com/sdk-for-php) (current latest version is **v3.188**) and place it in the application code root directory.

```json
{
   "require": {
      "aws/aws-sdk-php": "3.188"
   }
}
```

* Suppose you run ==`composer install`== manually in your local development environment, the `composer.lock` file is created beside the `composer.json` file.

* Place the line ==`composer install`== to the [run](/documentation/build/build-config.html#run) section of the [zerops.yml](/documentation/build/build-config.html) configuration file necessary for building your application.

```yaml
runs:
  - ...
  - composer install
  - ...
```

* The composer install process downloads necessary files and creates a new subdirectory `aws\aws-sdk-php` in the `vendor` directory placed directly in the application code root.

<!-- markdownlint-disable DOCSMD004 -->
::: info Where following code snippets are used
Suppose the code is used in a php file located in a [document root](/documentation/services/runtimes/php.html#setting-php-apache-document-root) subdirectory (for example, ==**`public`**== ) placed directly in the [application code root](/documentation/services/runtimes/php.html#application-code-root-and-document-root).
:::
<!-- markdownlint-enable DOCSMD004 -->

<!-- markdownlint-disable DOCSMD004 -->
::: warning Temporary solution
At this time, environment variables generated by Zerops Object Storage Services are **not available** in other services. For this reason, it is necessary to use their `accessKeyId`, `secretAccessKey`, or `apiUrl` values by manually copying them from the [environment variables](/documentation/environment-variables/how-to-access.html) card of the service details.

The code for getting ==**$credentials**== would be then:

```php
$credentials = new Credentials(
  '0LW7E_BUT-yKmmEcyf3dzQ',
  '4Gn_7jWqMcqUDs8n'
);
```

The code for getting ==**$apiUrlValue**== would be then:

```php
$apiUrlValue = 'https://s3.app.zerops.io';
```

This limitation is temporary only and will be removed as soon as possible.
:::
<!-- markdownlint-enable DOCSMD004 -->

## How to get access credentials

Using the following code, you will get a variable ==`$credentials`== containing an object used later for authentication when creating buckets and their content.

Assume further that the code is associated with access to the Zerops Object Storage Service, whose [object storage name](/documentation/services/storage/s3.html#object-storage-name) was chosen as the ==**`store`**== . Necessary [Storage access details](/documentation/services/storage/s3.html#from-local-development-environment) values **Access Key Id** and **Secret Access Key** are taken from [environment variables](/documentation/environment-variables/how-to-access.html) then.

<!-- markdownlint-disable DOCSMD004 -->
::: info
The unique generated id of the created Zerops Object Storage Service instance is used as the value of the **accessKeyId** environment variable. The value of **secretAccessKey** is a 16-characters random string.
:::
<!-- markdownlint-enable DOCSMD004 -->

```php
<?php
  // Include the SDK using the Composer auto-loader.
  require '../vendor/autoload.php';

  // Import relevant SDK classes.
  use Aws\S3\S3Client;
  use Aws\Credentials\Credentials;
  use Aws\Exception\AwsException;

  try {
    // Object storage name.
    $objetStorageName = 'store';
    // Necessary environment variable names.
    $accessKeyId = 'accessKeyId';
    $secretAccessKey = 'secretAccessKey';
    // Get an object with credentials.
    $credentials = new Credentials(
      getenv("{$objetStorageName}_${$accessKeyId}"),
      getenv("{$objetStorageName}_${secretAccessKey}")
    );
  } catch (AwsException $e) {
    echo 'Error: ' . $e->getAwsErrorMessage();
  }
?>
```

## Creating a new object storage bucket

When having `$credentials` from the previous code snippet (supposing all declared variables are also accessible), you can create a named bucket as a container for storing objects. Zerops uses the [multi-tenancy feature](https://docs.ceph.com/en/latest/radosgw/multitenancy) requiring buckets with [unique names](/documentation/services/storage/s3.html#object-store-bucket-names) only in the scope of each tenant.

```php
<?php
  // Required bucket name.
  // All bucket names in one Zerops Object Storage Service have to be unique!
  $bucketName = 'records';
  // Necessary environment variable name.
  $apiUrl = 'apiUrl';
  $apiUrlValue = getenv("{$objetStorageName}_${$apiUrl}");

  // Function declaration.
  function getS3Client($apiUrlValue, $credentials) {
    // Create a new S3 SDK client instance.
    return new S3Client([
      'version' => 'latest',
      // Zerops supports only the S3 default region for API calls.
      // It doesn't mean that the physical HW infrastructure is located there also.
      // All Zerops infrastructure is completely located in Europe/Prague.
      'region' => 'us-east-1',
      'endpoint' => $apiUrlValue,
      // Zerops supports currently only S3 path-style addressing model.
      // The virtual-hosted style model will be supported in near future.
      'use_path_style_endpoint' => true,
      'credentials' => $credentials
    ]);
  }

  // Function declaration.
  function createBucket($s3Client, $bucketName) {
    // Create a new bucket.
    return $s3Client->createBucket([
      'Bucket' => $bucketName
    ]);
  }

  // Calling the function: getS3Client
  $s3Client = getS3Client($apiUrlValue, $credentials);
  // Calling the function: createBucket
  $bucket = createBucket($s3Client, $bucketName);
?>
```

<!-- markdownlint-disable DOCSMD004 -->
::: info Created new bucket's URL
As the S3 path-style addressing model is used, the bucket's effective URL is:

```url
https://s3.app.zerops.io/records
```

:::
<!-- markdownlint-enable DOCSMD004 -->

## Getting an existed object storage bucket ACL setting

When having `$credentials` and `getS3Client` function from the previous code snippet (supposing all declared variables are also accessible), you can check the existence of a bucket and get its ACL setting.

```php
<?php
  // Required bucket name.
  $bucketName = 'records';

  // Function declaration.
  function getBucketAcl($s3Client, $bucketName) {
    // Check it the required bucket exists.
    if ($s3Client->doesBucketExist($bucketName)) {
      // If yes, return its ACL setting.
      return $s3Client->getBucketAcl([
        'Bucket' => $bucketName
      ]);
    }
    // If the bucket doesn't exist, return null.
    return null;
  }

  // Calling the function: getS3Client
  $s3Client = getS3Client($apiUrlValue, $credentials);
  // Calling the function: getBucketAcl
  $bucketAcl = getBucketAcl($s3Client, $bucketName);
?>
```

<!-- markdownlint-disable DOCSMD004 -->
::: info Default bucket's Grants setting
As mentioned in the documentation [Object storage owner identity](/documentation/services/storage/s3.html#object-storage-owner-identity), there is the only one grantee, equal to the owner, with the same name as the chosen [Object storage name](#object-storage-name) (for example, ==`store`== ).

```php
"Grants" => [
  [
    "Grantee" => [
      "DisplayName" => "store",
      "ID" => "0LW7E_BUT-yKmmEcyf3dzQ",
      "Type" => "CanonicalUser"
    ],
    "Permission" => "FULL_CONTROL"
  ]
]
```

:::
<!-- markdownlint-enable DOCSMD004 -->

<!-- markdownlint-disable DOCSMD004 -->
::: info Default bucket's @metadata headers
It's also worth listing the default setting of a bucket's headers related to the HTTPS public read/write access (authenticated access is currently not available through RESTful interface):

```php
"@metadata" => [
  "headers" => [
    "access-control-allow-origin" => "*",
    "access-control-allow-methods" => "GET, POST, PUT, DELETE, OPTIONS",
    "access-control-allow-headers" => "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization",
    "access-control-expose-headers" => "Content-Length,Content-Range"
  ]
]
```

:::
<!-- markdownlint-enable DOCSMD004 -->

## Update an existed object storage bucket ACL

When having `$credentials` and `getS3Client` function from the previous code snippet (supposing all declared variables are also accessible), you can check the existence of a bucket and modify its ACL setting to one of [canned grants](https://docs.aws.amazon.com/AmazonS3/latest/userguide/acl-overview.html#canned-acl).

```php
<?php
  // Required bucket name.
  $bucketName = 'records';

  // Function declaration.
  function putBucketAcl($s3Client, $bucketName) {
    // Check it the required bucket exists.
    if ($s3Client->doesBucketExist($bucketName)) {
      // If yes, modify its ACL setting to public read.
      return $s3Client->putBucketAcl([
        'Bucket' => $bucketName,
        'ACL' => 'public-read'
      ]);
    }
    // If the bucket doesn't exist, return null.
    return null;
  }

  // Calling the function: getS3Client
  $s3Client = getS3Client($apiUrlValue, $credentials);
  // Calling the function: putBucketAcl
  putBucketAcl($s3Client, $bucketName);
?>
```

Setting the ACL as ==`public-read`== adds another `Grantee` to the bucket's `Grants` list:

```php
[
  "Grantee" => [
    "Type" => "Group",
    "URI" => "http://acs.amazonaws.com/groups/global/AllUsers"
  ],
  "Permission" => "READ"
]
```

If you have another Zerops Object Storage Service in your project (for example, the one with ==`archivestore`== [Object Storage Name](/documentation/services/storage/s3.html#object-store-bucket-names)), you can set its buckets access rights to allow access from the ==`store`== service with [read](https://docs.aws.amazon.com/AmazonS3/latest/userguide/acl-overview.html#permissions) access.

<!-- markdownlint-disable DOCSMD004 -->
::: warning Grants work in overwriting mode
Setting ==`Grants`== requires defining the complete list of items ( ==`Grantee`== ) for the bucket because it overwrites the previous value. It doesn't work in an incremental mode. You will probably create a more sophisticated routine to prepare the **access control policy** you need. Here, it's simplified to the constant value.
:::
<!-- markdownlint-enable DOCSMD004 -->

```php
<?php
  // Required bucket name.
  $bucketName = 'records';

  $accessControlPolicy => [
    'Grants' => [
      [
        'Grantee' => [
          'DisplayName' => 'archivestore',
          'ID' => 'V4CvJVn-S5Gzzzq0yoRX7g',
          'Type' => 'CanonicalUser'
         ],
         'Permission' => 'FULL_CONTROL'
      ],
      [
        'Grantee' => [
          'DisplayName' => 'store',
          'ID' => '0LW7E_BUT-yKmmEcyf3dzQ',
          'Type' => 'CanonicalUser'
        ],
        'Permission' => 'READ'
      ]
    ]
  ];

  // Function declaration.
  function putBucketAcl($s3Client, $bucketName, $accessControlPolicy) {
    // Check it the required bucket exists.
    if ($s3Client->doesBucketExist($bucketName)) {
      // If yes, modify its AccessControlPolicy setting.
      return $s3Client->putBucketAcl([
        'Bucket' => $bucketName,
        'AccessControlPolicy' => $accessControlPolicy
      ]);
    }
    // If the bucket doesn't exist, return null.
    return null;
  }

  // Calling the function: getS3Client
  $s3Client = getS3Client($apiUrlValue, $credentials);
  // Calling the function: putBucketAcl
  putBucketAcl($s3Client, $bucketName, $accessControlPolicy);
?>
```

## Adding a new bucket's object (with body or a file)

When having `$credentials` from the previous code snippet (supposing all declared variables are also accessible), you can put a new object inside a bucket. You must have WRITE permissions on a bucket to add an object to it.

```php
<?php
  // Required bucket name.
  $bucketName = 'records';

  // Declaration of an object with body to be placed into a bucket.
  $objectBodyKey = "K1";
  $objectBody = "Description of the K1.";

  // Declaration of an object with a file to be placed into a bucket.
  $objectFileKey = "scan_20210815_00001";
  $filePath = "./files/" . $objectFileKey . ".jpg";


  // Function declaration.
  function putObjectWithBody($s3Client, $bucketName, $objectKey, $objectBodyKey) {
    // Check it the required bucket exists.
    if ($s3Client->doesBucketExist($bucketName)) {
      // If yes, put an object inside the bucket.
      return $s3Client->putObject([
        'Bucket' => $bucketName,
        'Key' => $objectKey,
        'Body' => $objectBody
      ]);
    }
    // If the bucket doesn't exist, return null.
    return null;
  }

  // Function declaration.
  function putObjectWithFile($s3Client, $bucketName, $objectFileKey, $filePath) {
    // Check it the required bucket exists.
    if ($s3Client->doesBucketExist($bucketName)) {
      // If yes, put an object inside the bucket.
      return $s3Client->putObject([
        'Bucket' => $bucketName,
        'Key' => $fileKey,
        'SourceFile' => $filePath
      ]);
    }
    // If the bucket doesn't exist, return null.
    return null;
  }

  // Calling the function: getS3Client
  $s3Client = getS3Client($apiUrlValue, $credentials);
  // Calling the function: putObjectBody
  $resultBody = putObjectWithBody($s3Client, $bucketName, $objectBodyKey, $objectBody);
  // Calling the function: putObjectFile
  $resultFile = putObjectWithFile($s3Client, $bucketName, $objectFileKey, $filePath);
?>
```

## Getting an existed bucket's object (with body or a file)

When having `$credentials` from the previous code snippet (supposing all declared variables are also accessible), you can get an already existed object from a bucket back. You must have READ permissions at least on a bucket to get an object from it.

```php
<?php
  // Required bucket name.
  $bucketName = 'records';

  // Declaration of an object key its body content to be get from a bucket.
  $objectBodyKey = "K1";
  // Declaration of an object key its file content to be downloaded from a bucket.
  $objectFileKey = "scan_20210815_00001";
  $filePath = "./files/" . $objectFileKey . ".jpg";

  // Function declaration.
  function getObjectBody($s3Client, $bucketName, $objectBodyKey) {
    // Check it the required bucket exists.
    if ($s3Client->doesBucketExist($bucketName)) {
      // Check it the required object exists.
      if ($s3Client->doesObjectExist($bucketName, $objectBodyKey)) {
        // If yes, get an object from the bucket.
        return $s3Client->getObject([
          'Bucket' => $bucketName,
          'Key' => $objectBodyKey
        ]);
      }
    }
    // If either a bucket or an object doesn't exist, return null.
    return null;
  }

  // Function declaration.
  function getObjectFile($s3Client, $bucketName, $objectFileKey, $filePath) {
    // Check it the required bucket exists.
    if ($s3Client->doesBucketExist($bucketName)) {
      // Check it the required object exists.
      if ($s3Client->doesObjectExist($bucketName, $objectBodyKey)) {
        // If yes, get an object from the bucket.
        return $s3Client->getObject([
          'Bucket' => $bucketName,
          'Key' => $objectBodyKey,
          'SaveAs' => $filePath
        ]);
      }
    }
    // If either a bucket or an object doesn't exist, return null.
    return null;
  }

  // Calling the function: getS3Client
  $s3Client = getS3Client($apiUrlValue, $credentials);

  // Calling the function to get an object body: getObjectBody
  $resultBody = getObjectBody($s3Client, $bucketName, $objectBodyKey);
  // Returned value contains the object body content.
  $objectBody = $resultBody["Body"];

  // Calling the function to download an object file: getObjectFile
  $resultFile = getObjectFile($s3Client, $bucketName, $objectFileKey, $filePath);
  // The downloaded file will be saved on disk as declared in the $filePath.
?>
```

